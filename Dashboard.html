<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Fish Tank + Weekly Dosage Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:Arial; background:#f4f7fb; padding:20px;}
    h1{color:#0b5670;}
    .card{background:#fff; padding:16px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.06); width:320px; margin:12px;}
    .row{display:flex; gap:12px; flex-wrap:wrap;}
    .value{font-size:28px; font-weight:700;}
    .status{margin-top:8px;font-weight:600;}
    .btn{padding:10px 14px; border-radius:8px; border:none; cursor:pointer;}
    .btn-open{background:#16a34a;color:#fff;}
    .btn-close{background:#dc2626;color:#fff;}
    #controls{display:flex;gap:10px;flex-direction:column;}
    .btn-dose{background:#0891b2;color:#fff;margin-top:10px;}
    canvas{width:100%!important; max-width:100%!important;}
  </style>
</head>
<body>
  <h1>Fish Tank Dashboard</h1>

  <!-- Sensor Cards -->
  <div class="row">
    <div class="card"><h3>pH</h3><div id="ph" class="value">--</div><div id="phStatus" class="status">--</div></div>
    <div class="card"><h3>Ammonia</h3><div id="ammonia" class="value">--</div><div id="amStatus" class="status">--</div></div>
    <div class="card"><h3>Temperature (Â°C)</h3><div id="temperature" class="value">--</div><div id="tempStatus" class="status">--</div></div>
  </div>

  <!-- Feeding Cards -->
  <div class="row">
    <div class="card"><h3>Tray Weight (g)</h3><div id="weight" class="value">--</div><div id="feedStatus" class="status">Status: Idle</div></div>

    <div class="card"><h3>Food Status</h3><div id="foodStatus" class="value">--</div></div>

    <!-- NEW DOSAGE LEVEL CARD -->
    <div class="card">
      <h3>Dosage Level (mL)</h3>
      <div id="doseLevel" class="value">--</div>
      <div id="doseLevelStatus" class="status">--</div>
    </div>

    <div class="card" id="controls">
      <h3>Feeding Controls</h3>
      <div style="display:flex;gap:8px;margin-bottom:8px;">
        <button class="btn btn-open" onclick="openMain()">Open Main</button>
        <button class="btn btn-close" onclick="closeMain()">Close Main</button>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-open" onclick="openLower()">Open Lower</button>
        <button class="btn btn-close" onclick="closeLower()">Close Lower</button>
      </div>
      <p style="margin-top:10px;font-size:13px;color:#444;">Tip: After pressing "Open Main", watch the weight. Close when ready.</p>
    </div>

    <div class="card"><h3>Temp Control Status</h3><div id="heaterStatus" class="status">Heater: --</div><div id="coolerStatus" class="status">Cooler: --</div></div>
  </div>

  <!-- Daily Dosage -->
  <div class="row">
    <div class="card">
      <h3>Daily Dosage</h3>
      <input id="doseInput" type="number" placeholder="Enter mL" style="width:80px;padding:6px;margin-bottom:8px;">
      <button class="btn btn-dose" onclick="startDosage()">Start Daily Dose</button>
      <div id="doseStatus" class="status" style="margin-top:12px;">Status: Idle</div>
    </div>
  </div>

  <!-- Weekly Dosage -->
  <h1>Weekly Dosage Dashboard</h1>
  <div class="row">
    <div class="card">
      <h3>Weekly Medicine</h3>
      <input id="weeklyDoseInput" type="number" placeholder="Enter mL" style="width:80px;padding:6px;margin-bottom:8px;">
      <button class="btn btn-dose" onclick="startWeeklyDose()">Start Weekly Dose</button>
      <div id="weeklyDoseStatus" class="status" style="margin-top:12px;">Status: --</div>
    </div>
  </div>

  <!-- Graph -->
  <div class="row">
    <div class="card" style="width:100%;">
      <h3>Dosage Levels Over Time</h3>
      <canvas id="dosageChart" height="200"></canvas>
    </div>
  </div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyASBX1WRqOyJea1fm4LXGIV1PHT_7GuCVo",
    authDomain: "exercise2-55d7c.firebaseapp.com",
    databaseURL: "https://exercise2-55d7c-default-rtdb.asia-southeast1.firebasedatabase.app/",
    projectId: "exercise2-55d7c",
    storageBucket: "exercise2-55d7c.appspot.com",
    messagingSenderId: "278969110850",
    appId: "1:278969110850:web:xxxx"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Elements
const phEl = document.getElementById('ph'),
      amEl = document.getElementById('ammonia'),
      tempEl = document.getElementById('temperature'),
      wEl = document.getElementById('weight');

const phStatus = document.getElementById('phStatus'),
      amStatus = document.getElementById('amStatus'),
      tempStatus = document.getElementById('tempStatus');

const feedStatus = document.getElementById('feedStatus'),
      heaterStatus = document.getElementById('heaterStatus'),
      coolerStatus = document.getElementById('coolerStatus');

const doseStatus = document.getElementById('doseStatus'),
      foodStatus = document.getElementById('foodStatus');

const weeklyDoseStatus = document.getElementById('weeklyDoseStatus');

// NEW: dosage level elements
const doseLevel = document.getElementById('doseLevel');
const doseLevelStatus = document.getElementById('doseLevelStatus');

// Feeding Functions
function setBool(path,val){ db.ref(path).set(val); }
function openMain(){ setBool('/feed/button_open_main',true); feedStatus.innerText="Status: Opening Main..."; }
function closeMain(){ setBool('/feed/button_close_main',true); feedStatus.innerText="Status: Closing Main..."; }
function openLower(){ setBool('/feed/button_open_lower',true); feedStatus.innerText="Status: Opening Lower..."; }
function closeLower(){ setBool('/feed/button_close_lower',true); feedStatus.innerText="Status: Closing Lower..."; }

// Daily Dosage
function startDosage(){
    const ml = Number(document.getElementById('doseInput').value);
    if(ml<=0){ alert("Enter valid mL"); return;}
    db.ref('/dose/ml').set(ml);
    db.ref('/dose/start').set(true);
    doseStatus.innerText="Status: Dispensing...";
    doseStatus.style.color="#0891b2";
}

// Weekly Dosage
function startWeeklyDose(){
    const ml = Number(document.getElementById('weeklyDoseInput').value);
    if(ml<=0){ alert("Enter valid mL"); return; }
    db.ref('/weeklyDose/hasPoured').get().then(snapshot=>{
        if(snapshot.val()===true){ alert("Medicine already poured!"); }
        else{
            db.ref('/weeklyDose/ml').set(ml);
            db.ref('/weeklyDose/start').set(true);
            weeklyDoseStatus.innerText="Status: Dispensing...";
            weeklyDoseStatus.style.color="#0891b2";
        }
    });
}

// Firebase Listeners
db.ref('/sensor/ph').on('value',snap=>{
    phEl.innerText=snap.val().toFixed(2);
    phStatus.innerText=(snap.val()>=6.5 && snap.val()<=8.5)?"Safe":"Harmful";
});

db.ref('/sensor/ammonia').on('value',snap=>{
    amEl.innerText=snap.val().toFixed(2);
    amStatus.innerText=(snap.val()<=25)?"Safe":"Harmful";
});

db.ref('/sensor/temperature').on('value',snap=>{
    tempEl.innerText=snap.val().toFixed(2);
});

db.ref('/feed/weight').on('value', snap => { 
    const w = snap.val();
    wEl.innerText = w ? w.toFixed(1) : "0.0";
});

db.ref('/feed/status').on('value',snap=>{ feedStatus.innerText="Status: "+snap.val(); });
db.ref('/feed/foodStatus').on('value',snap=>{ foodStatus.innerText=snap.val(); });
db.ref('/control/heater').on('value',snap=>{ heaterStatus.innerText="Heater: "+(snap.val()?"ON":"OFF"); });
db.ref('/control/cooler').on('value',snap=>{ coolerStatus.innerText="Cooler: "+(snap.val()?"ON":"OFF"); });
db.ref('/dose/status').on('value',snap=>{ doseStatus.innerText="Status: "+snap.val(); });
db.ref('/weeklyDose/status').on('value',snap=>{ weeklyDoseStatus.innerText="Status: "+snap.val(); });

// NEW LISTENER: dosage level
db.ref('/dose/level').on('value', snap => {
    const lvl = snap.val();
    doseLevel.innerText = lvl !== null ? lvl.toFixed(1) : "--";

    if (lvl >= 50) {
        doseLevelStatus.innerText = "Level: Full";
        doseLevelStatus.style.color = "green";
    } 
    else if (lvl >= 20) {
        doseLevelStatus.innerText = "Level: Medium";
        doseLevelStatus.style.color = "#d97706";
    } 
    else {
        doseLevelStatus.innerText = "Level: Low";
        doseLevelStatus.style.color = "red";
    }
});

// --- Chart.js Graph for Tank1 and Tank2 ---
const ctx = document.getElementById('dosageChart').getContext('2d');
const dosageChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [
            {
                label: 'Tank 1',
                data: [],
                borderColor: 'rgba(16,163,74,1)',
                backgroundColor: 'rgba(16,163,74,0.2)',
                fill: true,
                tension: 0.3
            },
            {
                label: 'Tank 2',
                data: [],
                borderColor: 'rgba(8,145,178,1)',
                backgroundColor: 'rgba(8,145,178,0.2)',
                fill: true,
                tension: 0.3
            }
        ]
    },
    options: {
        responsive: true,
        scales: {
            x: { title: { display: true, text: 'Time' } },
            y: { title: { display: true, text: 'Dosage Level (mL)' }, beginAtZero: true }
        }
    }
});

function addDosageData(tank1, tank2){
    const time = new Date().toLocaleTimeString();
    const maxPoints = 20;

    dosageChart.data.labels.push(time);
    dosageChart.data.datasets[0].data.push(tank1);
    dosageChart.data.datasets[1].data.push(tank2);

    if(dosageChart.data.labels.length > maxPoints){
        dosageChart.data.labels.shift();
        dosageChart.data.datasets[0].data.shift();
        dosageChart.data.datasets[1].data.shift();
    }

    dosageChart.update();
}

// Firebase listeners for Tank 1 and Tank 2
db.ref('/dose/tank1').on('value', snap => {
    const tank1Level = snap.val() || 0;
    db.ref('/dose/tank2').once('value').then(snap2 => {
        const tank2Level = snap2.val() || 0;
        addDosageData(tank1Level, tank2Level);
    });
});
</script>
</body>
</html>