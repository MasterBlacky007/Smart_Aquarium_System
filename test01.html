<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Fish Tank + Weekly Dosage Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body{font-family:Arial; background:#f4f7fb; padding:20px;}
    h1{color:#0b5670;}
    .card{background:#fff; padding:16px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.06); width:320px; margin:12px;}
    .row{display:flex; gap:12px; flex-wrap:wrap;}
    .value{font-size:28px; font-weight:700;}
    .status{margin-top:8px;font-weight:600;}
    .btn{padding:10px 14px; border-radius:8px; border:none; cursor:pointer;}
    .btn-open{background:#16a34a;color:#fff;}
    .btn-close{background:#dc2626;color:#fff;}
    #controls{display:flex;gap:10px;flex-direction:column;}
    .btn-dose{background:#0891b2;color:#fff;margin-top:10px;}
    canvas{width:100%!important; max-width:100%!important;}
  </style>
</head>
<body>
  <h1>Fish Tank Dashboard</h1>

  <!-- Sensor Cards -->
  <div class="row">
    <div class="card"><h3>pH</h3><div id="ph" class="value">--</div><div id="phStatus" class="status">--</div></div>
    <div class="card"><h3>Ammonia</h3><div id="ammonia" class="value">--</div><div id="amStatus" class="status">--</div></div>
    <div class="card"><h3>Temperature (Â°C)</h3><div id="temperature" class="value">--</div><div id="tempStatus" class="status">--</div></div>
  </div>

  <!-- Feeding Cards -->
  <div class="row">
    <div class="card"><h3>Tray Weight (g)</h3><div id="weight" class="value">--</div><div id="feedStatus" class="status">Status: Idle</div></div>

    <div class="card"><h3>Food Status</h3><div id="foodStatus" class="value">--</div></div>

    <!-- NEW DOSAGE LEVEL CARD -->
    <div class="card">
      <h3>Dosage Level (mL)</h3>
      <div id="doseLevel" class="value">--</div>
      <div id="doseLevelStatus" class="status">--</div>
    </div>

    <div class="card" id="controls">
      <h3>Feeding Controls</h3>
      <div style="display:flex;gap:8px;margin-bottom:8px;">
        <button class="btn btn-open" onclick="openMain()">Open Main</button>
        <button class="btn btn-close" onclick="closeMain()">Close Main</button>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-open" onclick="openLower()">Open Lower</button>
        <button class="btn btn-close" onclick="closeLower()">Close Lower</button>
      </div>
      <p style="margin-top:10px;font-size:13px;color:#444;">Tip: After pressing "Open Main", watch the weight. Close when ready.</p>
    </div>

    <div class="card"><h3>Temp Control Status</h3><div id="heaterStatus" class="status">Heater: --</div><div id="coolerStatus" class="status">Cooler: --</div></div>
  </div>

  <!-- Daily Dosage -->
  <div class="row">
    <div class="card">
      <h3>Daily Dosage</h3>
      <input id="doseInput" type="number" placeholder="Enter mL" style="width:80px;padding:6px;margin-bottom:8px;">
      <button class="btn btn-dose" onclick="startDosage()">Start Daily Dose</button>
      <div id="doseStatus" class="status" style="margin-top:12px;">Status: Idle</div>
    </div>
  </div>

  <!-- Weekly Dosage -->
  <h1>Weekly Dosage Dashboard</h1>
  <div class="row">
    <div class="card">
      <h3>Weekly Medicine</h3>
      <input id="weeklyDoseInput" type="number" placeholder="Enter mL" style="width:80px;padding:6px;margin-bottom:8px;">
      <button class="btn btn-dose" onclick="startWeeklyDose()">Start Weekly Dose</button>
      <div id="weeklyDoseStatus" class="status" style="margin-top:12px;">Status: --</div>
    </div>
  </div>

  <!-- Graph -->
  <div class="row">
    <div class="card" style="width:100%;">
      <h3>Dosage Levels Over Time</h3>
      <canvas id="dosageChart" height="200"></canvas>
    </div>
  </div>

<script type="module">

/* ---------------------- FIREBASE IMPORTS ----------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue } 
  from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

/* ---------------------- FIREBASE CONFIG ------------------------ */
const firebaseConfig = {
    apiKey: "AIzaSyANvMOIRcRdOjOIJ-GglO-iGyeel64ZG_U",
    authDomain: "smart-aquarium-system-3a19d.firebaseapp.com",
    databaseURL: "https://smart-aquarium-system-3a19d-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "smart-aquarium-system-3a19d",
    storageBucket: "smart-aquarium-system-3a19d.firebasestorage.app",
    messagingSenderId: "656318848878",
    appId: "1:656318848878:web:96fd9d56a25a222505ab7f"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ------------------------- ELEMENTS ---------------------------- */
const phEl = document.getElementById('ph'),
      amEl = document.getElementById('ammonia'),
      tempEl = document.getElementById('temperature'),
      wEl = document.getElementById('weight');

const phStatus = document.getElementById('phStatus'),
      amStatus = document.getElementById('amStatus'),
      tempStatus = document.getElementById('tempStatus');

const feedStatus = document.getElementById('feedStatus'),
      heaterStatus = document.getElementById('heaterStatus'),
      coolerStatus = document.getElementById('coolerStatus');

const doseStatus = document.getElementById('doseStatus'),
      foodStatus = document.getElementById('foodStatus');

const weeklyDoseStatus = document.getElementById('weeklyDoseStatus');

const doseLevel = document.getElementById('doseLevel');
const doseLevelStatus = document.getElementById('doseLevelStatus');

/* -------------------- Feeding Button Functions ------------------ */
function setBool(path,val){ set(ref(db,path), val); }

window.openMain = function(){
    setBool('/feed/button_open_main', true);
    feedStatus.innerText="Status: Opening Main...";
}
window.closeMain = function(){
    setBool('/feed/button_close_main', true);
    feedStatus.innerText="Status: Closing Main...";
}
window.openLower = function(){
    setBool('/feed/button_open_lower', true);
    feedStatus.innerText="Status: Opening Lower...";
}
window.closeLower = function(){
    setBool('/feed/button_close_lower', true);
    feedStatus.innerText="Status: Closing Lower...";
}

/* ----------------------- Daily Dosage -------------------------- */
window.startDosage = function(){
    const ml = Number(document.getElementById('doseInput').value);
    if(ml<=0){ alert("Enter valid mL"); return;}
    set(ref(db, '/dose/ml'), ml);
    set(ref(db, '/dose/start'), true);
    doseStatus.innerText="Status: Dispensing...";
    doseStatus.style.color="#0891b2";
}

/* ---------------------- Weekly Dosage -------------------------- */
window.startWeeklyDose = function(){
    const ml = Number(document.getElementById('weeklyDoseInput').value);
    if(ml<=0){ alert("Enter valid mL"); return; }

    get(ref(db, '/weeklyDose/hasPoured')).then(snapshot => {
        if(snapshot.val() === true){
            alert("Medicine already poured!");
        } else {
            set(ref(db, '/weeklyDose/ml'), ml);
            set(ref(db, '/weeklyDose/start'), true);
            weeklyDoseStatus.innerText="Status: Dispensing...";
            weeklyDoseStatus.style.color="#0891b2";
        }
    });
}

/* ----------------------- Firebase Listeners -------------------- */
onValue(ref(db, '/sensor/ph'), snap => {
    const v = snap.val();
    phEl.innerText = v.toFixed(2);
    phStatus.innerText = (v>=6.5 && v<=8.5) ? "Safe" : "Harmful";
});

onValue(ref(db, '/sensor/ammonia'), snap => {
    const v = snap.val();
    amEl.innerText = v.toFixed(2);
    amStatus.innerText = (v<=25) ? "Safe" : "Harmful";
});

onValue(ref(db, '/sensor/temperature'), snap => {
    tempEl.innerText = snap.val().toFixed(2);
});

onValue(ref(db, '/feed/weight'), snap => { 
    const w = snap.val();
    wEl.innerText = w ? w.toFixed(1) : "0.0";
});

onValue(ref(db, '/feed/status'), snap => { feedStatus.innerText="Status: "+snap.val(); });
onValue(ref(db, '/feed/foodStatus'), snap => { foodStatus.innerText = snap.val(); });
onValue(ref(db, '/control/heater'), snap => { heaterStatus.innerText = "Heater: "+(snap.val()?"ON":"OFF"); });
onValue(ref(db, '/control/cooler'), snap => { coolerStatus.innerText = "Cooler: "+(snap.val()?"ON":"OFF"); });
onValue(ref(db, '/dose/status'), snap => { doseStatus.innerText="Status: "+snap.val(); });
onValue(ref(db, '/weeklyDose/status'), snap => { weeklyDoseStatus.innerText="Status: "+snap.val(); });

/* ---------- Dosage Level Monitoring (Tank Status) ------------ */
onValue(ref(db, '/dose/level'), snap => {
    const lvl = snap.val();
    doseLevel.innerText = lvl !== null ? lvl.toFixed(1) : "--";

    if (lvl >= 50) {
        doseLevelStatus.innerText = "Level: Full";
        doseLevelStatus.style.color = "green";
    } 
    else if (lvl >= 20) {
        doseLevelStatus.innerText = "Level: Medium";
        doseLevelStatus.style.color = "#d97706";
    } 
    else {
        doseLevelStatus.innerText = "Level: Low";
        doseLevelStatus.style.color = "red";
    }
});

/* ----------------------- Dosage Chart -------------------------- */
const ctx = document.getElementById('dosageChart').getContext('2d');
const dosageChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [
            {
                label: 'Tank 1',
                data: [],
                borderColor: 'rgba(16,163,74,1)',
                backgroundColor: 'rgba(16,163,74,0.2)',
                fill: true,
                tension: 0.3
            },
            {
                label: 'Tank 2',
                data: [],
                borderColor: 'rgba(8,145,178,1)',
                backgroundColor: 'rgba(8,145,178,0.2)',
                fill: true,
                tension: 0.3
            }
        ]
    },
    options: {
        responsive: true,
        scales: {
            x: { title: { display: true, text: 'Time' } },
            y: { title: { display: true, text: 'Dosage Level (mL)' }, beginAtZero: true }
        }
    }
});

function addDosageData(tank1, tank2){
    const time = new Date().toLocaleTimeString();
    const maxPoints = 20;

    dosageChart.data.labels.push(time);
    dosageChart.data.datasets[0].data.push(tank1);
    dosageChart.data.datasets[1].data.push(tank2);

    if(dosageChart.data.labels.length > maxPoints){
        dosageChart.data.labels.shift();
        dosageChart.data.datasets[0].data.shift();
        dosageChart.data.datasets[1].data.shift();
    }

    dosageChart.update();
}

/* Listen for Tank 1 & Tank 2 changes */
onValue(ref(db, '/dose/tank1'), snap => {
    const tank1 = snap.val() || 0;
    get(ref(db, '/dose/tank2')).then(snap2 => {
        const tank2 = snap2.val() || 0;
        addDosageData(tank1, tank2);
    });
});

</script>

</body>
</html>
